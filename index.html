<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>OSM æ ¡å›­åœ°å›¾</title>
  <link href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/pinyin-pro@3.19.6/dist/index.js"></script>
  <style>
    body, html { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    
    /* æœç´¢æ æ ·å¼ */
    .search-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      width: 300px;
      max-width: calc(100vw - 250px);
    }
    
    .search-box {
      /* width: 100%; */
      padding: 12px 15px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
      outline: none;
    }
    
    .search-results {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      margin-top: 5px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }
    
    .search-results.show {
      display: block;
    }
    
    .search-result-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 13px;
      font-family: Arial, sans-serif;
    }
    
    .search-result-item:last-child {
      border-bottom: none;
    }
    
    .search-result-item:hover {
      background: #f5f5f5;
    }
    
    .search-result-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 3px;
    }
    
    .search-result-category {
      font-size: 12px;
      color: #666;
    }
    
    /* å›¾å±‚æ§åˆ¶é¢æ¿æ ·å¼ */
    .layer-control {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-height: 80vh;
      overflow-y: auto;
      z-index: 1000;
      font-family: Arial, sans-serif;
      min-width: 220px;
    }
    
    .layer-control h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      font-weight: bold;
      color: #333;
    }
    
    .layer-control label {
      display: flex;
      align-items: center;
      margin: 8px 0;
      cursor: pointer;
      font-size: 13px;
    }
    
    .layer-control input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
    }
    
    .layer-control .color-indicator {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
      border: 2px solid white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    
    .layer-control-content {
      display: block;
    }
    
    .layer-toggle-btn {
      display: none;
      width: 100%;
      padding: 8px;
      background: #2563EB;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 10px;
      font-family: Arial, sans-serif;
    }
    
    .layer-toggle-btn:active {
      background: #1d4ed8;
    }
    
    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      .search-container {
        width: calc(100vw - 20px);
        max-width: none;
        left: 10px;
        right: 10px;
      }

      .layer-control {
        top: auto;
        bottom: 10px;
        right: 10px;
        left: 10px;
        max-height: 60vh;
        max-width: none;
        padding: 10px;
        transition: transform 0.3s ease, opacity 0.3s ease;
      }
      
      .layer-control.collapsed .layer-control-content {
        display: none;
      }
      
      .layer-toggle-btn {
        display: block;
      }
      
      .layer-control h3 {
        font-size: 13px;
        margin: 0 0 8px 0;
      }
      
      .layer-control label {
        font-size: 12px;
        margin: 6px 0;
      }
      
      .layer-control .color-indicator {
        width: 14px;
        height: 14px;
      }
    }
  </style>
</head>
<body>
<div id="map"></div>

<!-- æœç´¢æ  -->
<div class="search-container">
  <input type="text" class="search-box" id="search-input" placeholder="Search / æœç´¢åç§°æˆ–ç±»åˆ«...">
  <div class="search-results" id="search-results"></div>
</div>

<!-- å›¾å±‚æ§åˆ¶é¢æ¿ -->
<div class="layer-control collapsed">
  <button class="layer-toggle-btn" id="layer-toggle">
    <span id="toggle-text">ğŸ“ Show Filters / æ˜¾ç¤ºç­›é€‰</span>
  </button>
  <div class="layer-control-content">
    <h3>Categories / ç±»åˆ«</h3>
    <label>
    <input type="checkbox" id="category-dormitory" checked>
    <span class="color-indicator" style="background: #60A5FA;"></span>
    <span>Dormitory / å®¿èˆæ¥¼</span>
  </label>
  <label>
    <input type="checkbox" id="category-university" checked>
    <span class="color-indicator" style="background: #2563EB;"></span>
    <span>Academic / æ•™å­¦æ¥¼</span>
  </label>
  <label>
    <input type="checkbox" id="category-building_other" checked>
    <span class="color-indicator" style="background: #94A3B8;"></span>
    <span>Other Building / å…¶ä»–å»ºç­‘</span>
  </label>
  <label>
    <input type="checkbox" id="category-restaurant" checked>
    <span class="color-indicator" style="background: #EF4444;"></span>
    <span>Restaurant / é¤å…</span>
  </label>
  <label>
    <input type="checkbox" id="category-cafe" checked>
    <span class="color-indicator" style="background: #F87171;"></span>
    <span>Cafe / å’–å•¡å…</span>
  </label>
  <label>
    <input type="checkbox" id="category-food_court" checked>
    <span class="color-indicator" style="background: #DC2626;"></span>
    <span>Food Court / é£Ÿå ‚</span>
  </label>
  <label>
    <input type="checkbox" id="category-fast_food" checked>
    <span class="color-indicator" style="background: #FCA5A5;"></span>
    <span>Fast Food / å¿«é¤</span>
  </label>
  <label>
    <input type="checkbox" id="category-shop" checked>
    <span class="color-indicator" style="background: #F59E0B;"></span>
    <span>Shop / å•†åº—</span>
  </label>
  <label>
    <input type="checkbox" id="category-office" checked>
    <span class="color-indicator" style="background: #8B5CF6;"></span>
    <span>Office / åŠå…¬å®¤</span>
  </label>
  <label>
    <input type="checkbox" id="category-parking" checked>
    <span class="color-indicator" style="background: #059669;"></span>
    <span>Parking / åœè½¦</span>
  </label>
  <label>
    <input type="checkbox" id="category-amenity" checked>
    <span class="color-indicator" style="background: #10B981;"></span>
    <span>Amenity / è®¾æ–½</span>
  </label>
  <label>
    <input type="checkbox" id="category-healthcare" checked>
    <span class="color-indicator" style="background: #EC4899;"></span>
    <span>Healthcare / åŒ»ç–—</span>
  </label>
  <label>
    <input type="checkbox" id="category-tourism" checked>
    <span class="color-indicator" style="background: #14B8A6;"></span>
    <span>Tourism / æ—…æ¸¸</span>
  </label>
  <label>
    <input type="checkbox" id="category-leisure" checked>
    <span class="color-indicator" style="background: #F97316;"></span>
    <span>Leisure / ä¼‘é—²</span>
  </label>
  <label>
    <input type="checkbox" id="category-default" checked>
    <span class="color-indicator" style="background: #6B7280;"></span>
    <span>Other / å…¶ä»–</span>
  </label>
  </div>
</div>

<script>
  const map = new maplibregl.Map({
    container: 'map',
    style: 'https://vps.haotian22.top:8081/styles/osm-liberty/style.json',
    center: [113.514982, 22.354065], // ä¿®æ”¹ä¸ºæ•°æ®ä¸­å¿ƒç‚¹
    zoom: 17 // ä¿®æ”¹ä¸ºæ•°æ®æ”¯æŒçš„ç¼©æ”¾çº§åˆ«
  });

  // åˆ†ç±»é¢œè‰²é…ç½®
  const categoryColors = {
    // å»ºç­‘ç‰©
    dormitory: { color: '#60A5FA', label: 'Dormitory / å®¿èˆæ¥¼' },
    university: { color: '#2563EB', label: 'Academic Building / æ•™å­¦æ¥¼' },
    building_other: { color: '#94A3B8', label: 'Other Building / å…¶ä»–å»ºç­‘' },
    
    // é¤é¥®
    restaurant: { color: '#EF4444', label: 'Restaurant / é¤å…' },
    cafe: { color: '#F87171', label: 'Cafe / å’–å•¡å…' },
    food_court: { color: '#DC2626', label: 'Food Court / é£Ÿå ‚' },
    fast_food: { color: '#FCA5A5', label: 'Fast Food / å¿«é¤' },
    
    // å•†åº—
    shop: { color: '#F59E0B', label: 'Shop / å•†åº—' },
    
    // åŠå…¬å®¤
    office: { color: '#8B5CF6', label: 'Office / åŠå…¬å®¤' },
    
    // è®¾æ–½æœåŠ¡
    amenity: { color: '#10B981', label: 'Amenity / è®¾æ–½' },
    parking: { color: '#059669', label: 'Parking / åœè½¦' },
    
    // åŒ»ç–—
    healthcare: { color: '#EC4899', label: 'Healthcare / åŒ»ç–—' },
    
    // æ—…æ¸¸æ–‡åŒ–
    tourism: { color: '#14B8A6', label: 'Tourism / æ—…æ¸¸' },
    
    // ä¼‘é—²å¨±ä¹
    leisure: { color: '#F97316', label: 'Leisure / ä¼‘é—²' },
    
    // é»˜è®¤
    default: { color: '#6B7280', label: 'POI / åœ°ç‚¹' }
  };

  // å­˜å‚¨æ‰€æœ‰æ ‡è®°ç‚¹
  const markers = [];
  const markerData = []; // å­˜å‚¨æ ‡è®°ç‚¹çš„è¯¦ç»†æ•°æ®ç”¨äºæœç´¢
  
  // ä½¿ç”¨ pinyin-pro åº“è¿›è¡Œæ‹¼éŸ³è½¬æ¢
  function getPinyin(text) {
    if (!text) return '';
    try {
      // ä½¿ç”¨ pinyin-pro çš„ pinyin å‡½æ•°ï¼Œå»é™¤å£°è°ƒï¼Œè¿”å›è¿ç»­çš„æ‹¼éŸ³
      return window.pinyinPro.pinyin(text, { toneType: 'none', type: 'array' }).join('').toLowerCase();
    } catch (e) {
      console.warn('æ‹¼éŸ³è½¬æ¢å¤±è´¥:', e);
      return text.toLowerCase();
    }
  }

  // æ ¹æ®å±æ€§ç¡®å®šç±»åˆ«å’Œé¢œè‰²
  function getCategoryInfo(props) {
    // å»ºç­‘ç‰©åˆ†ç±»
    if (props.building === 'dormitory') {
      return categoryColors.dormitory;
    }
    if (props.building === 'university') {
      return categoryColors.university;
    }
    if (props.building && props.building !== 'yes') {
      return categoryColors.building_other;
    }
    
    // é¤é¥®åˆ†ç±»
    if (props.amenity === 'restaurant') return categoryColors.restaurant;
    if (props.amenity === 'cafe') return categoryColors.cafe;
    if (props.amenity === 'food_court') return categoryColors.food_court;
    if (props.amenity === 'fast_food') return categoryColors.fast_food;
    
    // å•†åº—
    if (props.shop) return categoryColors.shop;
    
    // åŠå…¬å®¤
    if (props.office) return categoryColors.office;
    
    // åœè½¦
    if (props.amenity && (props.amenity.includes('parking') || props.amenity === 'bicycle_parking')) {
      return categoryColors.parking;
    }
    
    // åŒ»ç–—
    if (props.healthcare || props.amenity === 'doctors') return categoryColors.healthcare;
    
    // æ—…æ¸¸
    if (props.tourism) return categoryColors.tourism;
    
    // ä¼‘é—²
    if (props.leisure) return categoryColors.leisure;
    
    // å…¶ä»–è®¾æ–½
    if (props.amenity) return categoryColors.amenity;
    
    // é»˜è®¤
    return categoryColors.default;
  }

  // ä»æœ¬åœ° GeoJSON æ–‡ä»¶è¯»å–æ•°æ®
  fetch("export.geojson")
    .then(res => res.json())
    .then(geojson => {
      geojson.features.forEach(feature => {
        const coords = feature.geometry.coordinates;
        let lon, lat;

        // å¤„ç†ä¸åŒçš„å‡ ä½•ç±»å‹
        if (feature.geometry.type === 'Point') {
          [lon, lat] = coords;
        } else if (feature.geometry.type === 'Polygon' || feature.geometry.type === 'LineString') {
          // è®¡ç®—ä¸­å¿ƒç‚¹
          const allCoords = feature.geometry.type === 'Polygon' ? coords[0] : coords;
          const center = allCoords.reduce((acc, coord) => {
            acc[0] += coord[0];
            acc[1] += coord[1];
            return acc;
          }, [0, 0]);
          lon = center[0] / allCoords.length;
          lat = center[1] / allCoords.length;
        } else {
          return; // è·³è¿‡å…¶ä»–å‡ ä½•ç±»å‹
        }

        const props = feature.properties;
        
        // å¤„ç†åç§°ï¼šè‹±æ–‡/ä¸­æ–‡æ ¼å¼
        let displayName = "æœªå‘½å";
        const nameEn = props?.['name:en'];
        const nameZh = props?.['name:zh'] || props?.name;
        
        if (nameEn && nameZh) {
          displayName = `${nameEn} <br> ${nameZh}`;
        } else if (nameEn) {
          displayName = nameEn;
        } else if (nameZh) {
          displayName = nameZh;
        }
        
        const categoryInfo = getCategoryInfo(props);

        // æ„å»ºå¼¹çª—å†…å®¹
        let popupContent = `<div style="font-family: Arial, sans-serif;">
          <h3 style="margin: 0 0 8px 0; color: ${categoryInfo.color};">${displayName}</h3>
          <p style="margin: 4px 0; color: #666;"> ${categoryInfo.label}</p>`;
        
        // æ·»åŠ å…¶ä»–æœ‰ç”¨ä¿¡æ¯
        if (props.amenity) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Amenity / è®¾æ–½:</strong> ${props.amenity}</p>`;
        if (props.building && props.building !== 'yes') popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Building / å»ºç­‘:</strong> ${props.building}</p>`;
        if (props.shop) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Shop / å•†åº—:</strong> ${props.shop}</p>`;
        if (props.cuisine) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Cuisine / èœç³»:</strong> ${props.cuisine}</p>`;
        if (props.opening_hours) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Opening Hours / è¥ä¸šæ—¶é—´:</strong> ${props.opening_hours}</p>`;
        
        // æ·»åŠ æ›´å¤šä¸“æœ‰å±æ€§
        if (props['level:ref']) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Floor / æ¥¼å±‚:</strong> ${props['level:ref']}</p>`;
        if (props.phone) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Phone / ç”µè¯:</strong> ${props.phone}</p>`;
        if (props.website) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Website / ç½‘ç«™:</strong> <a href="${props.website}" target="_blank" style="color: ${categoryInfo.color};">é“¾æ¥</a></p>`;
        
        popupContent += '</div>';

        const marker = new maplibregl.Marker({
          color: categoryInfo.color
        })
          .setLngLat([lon, lat])
          .setPopup(new maplibregl.Popup().setHTML(popupContent))
          .addTo(map);
        
        // è·å–ç±»åˆ«é”®å
        const categoryKey = Object.keys(categoryColors).find(key => 
          categoryColors[key].color === categoryInfo.color && 
          categoryColors[key].label === categoryInfo.label
        );
        
        // å­˜å‚¨æ ‡è®°ç‚¹åŠå…¶ç±»åˆ«
        markers.push({
          marker: marker,
          category: categoryKey || 'default'
        });
        
        // å­˜å‚¨ç”¨äºæœç´¢çš„æ•°æ®
        markerData.push({
          marker: marker,
          category: categoryKey || 'default',
          name: displayName.replace('<br>', ' '),
          nameEn: nameEn || '',
          nameZh: nameZh || '',
          namePinyin: getPinyin(nameZh || ''),
          shortName: props.short_name || '',
          shortNamePinyin: getPinyin(props.short_name || ''),
          categoryLabel: categoryInfo.label,
          lngLat: [lon, lat],
          props: props
        });
      });
      
      // æœç´¢åŠŸèƒ½
      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');
      
      searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query.length === 0) {
          searchResults.classList.remove('show');
          searchResults.innerHTML = '';
          return;
        }
        
        // æœç´¢åŒ¹é…é¡¹
        const matches = markerData.filter(item => {
          return item.nameEn.toLowerCase().includes(query) ||
                 item.nameZh.toLowerCase().includes(query) ||
                 item.namePinyin.includes(query) ||
                 item.shortName.toLowerCase().includes(query) ||
                 item.shortNamePinyin.includes(query) ||
                 item.categoryLabel.toLowerCase().includes(query) ||
                 item.props.amenity?.toLowerCase().includes(query) ||
                 item.props.building?.toLowerCase().includes(query) ||
                 item.props.shop?.toLowerCase().includes(query);
        }).slice(0, 10); // æœ€å¤šæ˜¾ç¤º10æ¡ç»“æœ
        
        if (matches.length > 0) {
          searchResults.innerHTML = matches.map(item => `
            <div class="search-result-item" data-index="${markerData.indexOf(item)}">
              <div class="search-result-name">${item.name || 'æœªå‘½å'}</div>
              <div class="search-result-category">${item.categoryLabel}</div>
            </div>
          `).join('');
          searchResults.classList.add('show');
        } else {
          searchResults.innerHTML = '<div class="search-result-item">No results / æ— ç»“æœ</div>';
          searchResults.classList.add('show');
        }
      });
      
      // ç‚¹å‡»æœç´¢ç»“æœ
      searchResults.addEventListener('click', function(e) {
        const item = e.target.closest('.search-result-item');
        if (item && item.dataset.index) {
          const data = markerData[parseInt(item.dataset.index)];
          
          // å®šä½åˆ°æ ‡è®°ç‚¹
          map.flyTo({
            center: data.lngLat,
            zoom: 19,
            duration: 1000
          });
          
          // æ‰“å¼€å¼¹çª—
          setTimeout(() => {
            data.marker.togglePopup();
          }, 1000);
          
          // æ¸…ç©ºæœç´¢
          searchInput.value = '';
          searchResults.classList.remove('show');
          searchResults.innerHTML = '';
        }
      });
      
      // ç‚¹å‡»åœ°å›¾å…¶ä»–åœ°æ–¹å…³é—­æœç´¢ç»“æœ
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
          searchResults.classList.remove('show');
        }
      });
      
      // ç§»åŠ¨ç«¯å›¾å±‚æ§åˆ¶é¢æ¿å±•å¼€/æ”¶èµ·
      const layerControl = document.querySelector('.layer-control');
      const layerToggle = document.getElementById('layer-toggle');
      const toggleText = document.getElementById('toggle-text');
      
      if (layerToggle) {
        layerToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          layerControl.classList.toggle('collapsed');
          
          if (layerControl.classList.contains('collapsed')) {
            toggleText.textContent = 'ğŸ“ Show Filters / æ˜¾ç¤ºç­›é€‰';
          } else {
            toggleText.textContent = 'âœ– Hide Filters / éšè—ç­›é€‰';
          }
        });
      }
      
      // è®¾ç½®å¤é€‰æ¡†äº‹ä»¶ç›‘å¬
      Object.keys(categoryColors).forEach(category => {
        const checkbox = document.getElementById(`category-${category}`);
        if (checkbox) {
          checkbox.addEventListener('change', function() {
            const isVisible = this.checked;
            markers.forEach(item => {
              if (item.category === category) {
                const element = item.marker.getElement();
                element.style.display = isVisible ? '' : 'none';
              }
            });
          });
        }
      });
    })
    .catch(err => {
      console.error('åŠ è½½ GeoJSON æ–‡ä»¶å¤±è´¥:', err);
      alert('æ— æ³•åŠ è½½ export.geojson æ–‡ä»¶,è¯·ç¡®ä¿æ–‡ä»¶ä¸ HTML åœ¨åŒä¸€ç›®å½•ä¸‹');
    });
</script>
</body>
</html>
