<!DOCTYPE html>
<html>
<head>
    <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8B9JZM35BP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-8B9JZM35BP');
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BNBU Map | BNBU æ ¡å›­åœ°å›¾</title>
  <link href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/pinyin-pro@3.19.6/dist/index.js"></script>
  <style>
    body, html { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    
    /* æœç´¢æ æ ·å¼ */
    .search-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      width: 300px;
      max-width: calc(100vw - 250px);
    }
    
    .search-box {
      width: 100%;
      box-sizing: border-box;
      padding: 12px 15px;
      font-size: 14px;
      border: none;
      border-radius: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
      outline: none;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px) saturate(100%);
      -webkit-backdrop-filter: blur(10px) saturate(100%);
    }
    
    .search-results {
      scrollbar-color: grey rgba(255,255,225,0);
      scrollbar-width: none;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px) saturate(100%);
      -webkit-backdrop-filter: blur(10px) saturate(100%);
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      margin-top: 6px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }
    
    .search-results.show {
      display: block;
    }
    
    .search-result-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 13px;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .search-result-item:last-child {
      border-bottom: none;
    }
    
    .search-result-item:hover {
      background: #f5f5f5;
    }
    
    .search-result-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 3px;
    }
    
    .search-result-category {
      font-size: 12px;
      color: #666;
    }
    
    .search-result-info {
      flex: 1;
    }
    
    .search-result-distance {
      font-size: 12px;
      color: #2563EB;
      font-weight: 500;
      margin-left: 10px;
      white-space: nowrap;
    }
    
    /* å›¾å±‚æ§åˆ¶é¢æ¿æ ·å¼ */
    .layer-control {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px) saturate(100%);
      -webkit-backdrop-filter: blur(10px) saturate(100%);
      padding: 15px;
      border-radius: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-height: 80vh;
      overflow-y: auto;
      z-index: 1000;
      font-family: Arial, sans-serif;
      min-width: 250px;
    }
    
    .layer-control h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      font-weight: bold;
      color: #333;
    }
    
    .filter-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .filter-btn {
      flex: 1;
      padding: 6px 10px;
      font-size: 11px;
      background: #d5e7ff;
      color: #4b5563;
      border: 1px;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: Arial, sans-serif;
    }
    
    .filter-btn:hover {
      background: #daeaff;
      border-color: #9ca3af;
    }
    
    .filter-btn:active {
      background: #bdd7ff;
    }
    
    .category-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      margin: 6px 0;
      cursor: pointer;
      font-size: 13px;
      border-radius: 30px;
      transition: all 0.6s;
      background: #eff6ff;
      border: 2px solid transparent;
    }
    
    .category-item:hover {
      background: #daeaff;
    }
    
    .category-item.selected {
      background: #eff6ff;
      border-color: #3b82f6;
    }
    
    .color-indicators {
      display: flex;
      gap: 4px;
      margin-right: 10px;
    }
    
    .color-indicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    
    .layer-control-content {
      /* max-height will be set by JavaScript updateContentHeight() */
      opacity: 1;
      overflow-y: auto;
      scrollbar-width: none;
      transition: max-height 1s cubic-bezier(0.4, 0, 0.2, 1), 
                  opacity 0.7s ease-in-out;
    }
    
    .layer-control.collapsed .layer-control-content {
      max-height: 0 !important;
      opacity: 0;
      transition: max-height 1s cubic-bezier(0.4, 0, 0.2, 1), 
                  opacity 0.7s ease-in-out;
    }
    
    .layer-toggle-btn {
      width: 70%;
      padding: 8px;
      background: #2563EB;
      color: white;
      border: none;
      border-radius: 30px;
      font-size: 13px;
      cursor: pointer;
      font-family: Arial, sans-serif;
      transition: background 0.2s;
    }
    
    .layer-toggle-btn:hover {
      background: #1d4ed8;
    }
    
    .layer-toggle-btn:active {
      background: #1e40af;
    }
    
    .control-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .osm-attribution {
      display: none;
      font-size: 10px;
      color: #999;
      text-align: center;
      margin-top: 8px;
      line-height: 1.4;
    }
    
    .osm-attribution a {
      color: #2563EB;
      text-decoration: none;
    }
    
    .osm-attribution a:hover {
      text-decoration: underline;
    }

    .feedback-note {
      font-size: 10px;
      color: #999;
      text-align: center;
      margin-top: 5px;
    }

    .feedback-note a {
      color: #2563EB;
      text-decoration: none;
    }
    .feedback-note a:hover {
      text-decoration: underline;
    }

    
    /* å®šä½æŒ‰é’®æ ·å¼ */
    .locate-button {
      flex: 1;
      padding: 8px;
      background: white;
      color: #2563EB;
      border: 1px solid #2563EB;
      border-radius: 30px;
      font-size: 13px;
      cursor: pointer;
      font-family: Arial, sans-serif;
      transition: all 0.2s;
    }
    
    .locate-button:hover {
      background: #eff6ff;
    }
    
    .locate-button:active {
      background: #dbeafe;
    }
    
    .locate-button.active,
    .locate-button.locating {
      background: #2563EB;
      color: white;
    }
    
    .locate-button.active:hover {
      background: #1d4ed8;
    }
    
    .locate-button.active:active {
      background: #1e40af;
    }
    
    .locate-button.locating {
      animation: pulse 1.5s infinite;
    }
    
    .maplibregl-popup-content {
      box-shadow: 0 1px 6px rgba(0,0,0,.2);
      border-radius: 12px;
      backdrop-filter: blur(10px) saturate(100%);
      -webkit-backdrop-filter: blur(10px) saturate(100%);
      background: rgba(255, 255, 255, 0.85);
      animation: popupFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .maplibregl-popup-anchor-bottom .maplibregl-popup-tip {
      border-top-color: rgba(255, 255, 255, 0.84);
      animation: popupFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes popupFadeIn {
      0% {
        opacity: 0;
      }
      100% {
        opacity: 1;
      }
    }

    @keyframes popupFadeOut {
      0% {
        opacity: 1;
      }
      100% {
        opacity: 0;
      }
    }

    .maplibregl-popup.closing .maplibregl-popup-content {
      animation: popupFadeOut 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .maplibregl-popup.closing .maplibregl-popup-tip {
      animation: popupFadeOut 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    /* æ ‡è®°æ˜¾ç¤º/éšè—åŠ¨ç”» */
    .maplibregl-marker {
      transition: opacity 0.6s ease;
      opacity: 1;
    }

    .maplibregl-marker.marker-hidden {
      opacity: 0;
      pointer-events: none;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    /* åŠ è½½æ¡æ ·å¼ */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    
    .loading-overlay.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-content {
      text-align: center;
      font-family: Arial, sans-serif;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #2563EB;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 16px;
      color: #333;
      margin-bottom: 10px;
      font-weight: 500;
    }
    
    .loading-subtext {
      font-size: 12px;
      color: #666;
    }
    
    .loading-progress-bar {
      width: 250px;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
      margin: 15px auto 0;
    }
    
    .loading-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #2563EB, #3b82f6);
      border-radius: 2px;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      .search-container {
        width: calc(100vw - 20px);
        max-width: none;
        left: 10px;
        right: 10px;
      }

      .layer-control {
        top: auto;
        bottom: 10px;
        right: 10px;
        left: 10px;
        max-height: 65vh;
        max-width: none;
        padding: 10px;
        scrollbar-width: none;
        /* transition: all 1s cubic-bezier(0.4, 0, 0.2, 1); */
      }


      
      .layer-toggle-btn {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 12px;
        font-size: 14px;
      }
      
      .locate-button {
        padding: 12px;
        font-size: 14px;
      }
      
      .layer-control h3 {
        font-size: 13px;
        margin: 0 0 8px 0;
      }
      
      .category-item {
        font-size: 12px;
        padding: 8px 10px;
        margin: 4px 0;
      }
      
      .color-indicator {
        width: 12px;
        height: 12px;
      }
      
      .filter-btn {
        font-size: 10px;
        padding: 5px 8px;
      }
      
      .osm-attribution {
        display: block;
      }
    }
  </style>
</head>
<body>
<!-- åŠ è½½æç¤º -->
<div class="loading-overlay" id="loading-overlay">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading Map / åœ°å›¾åŠ è½½ä¸­...</div>
    <div class="loading-subtext">Preparing map tiles / æ­£åœ¨å‡†å¤‡åœ°å›¾ç“¦ç‰‡</div>
    <div class="loading-progress-bar">
      <div class="loading-progress-fill" id="loading-progress"></div>
    </div>
  </div>
</div>

<div id="map"></div>

<!-- æœç´¢æ  -->
<div class="search-container">
  <input type="text" class="search-box" id="search-input" placeholder="Search / æœç´¢åç§°æˆ–ç±»åˆ«...">
  <div class="search-results" id="search-results"></div>
</div>

<!-- å›¾å±‚æ§åˆ¶é¢æ¿ -->
<div class="layer-control collapsed">
  <div class="control-buttons">
    <button class="layer-toggle-btn" id="layer-toggle">
      <span id="toggle-text">âš™ Filters / ç­›é€‰</span>
    </button>
    <button class="locate-button" id="locate-button">
      <span id="locate-text">ğŸ“ GPS</span>
    </button>
  </div>
  <div class="layer-control-content">
    <h3>Categories / ç±»åˆ«</h3>
    
    <div class="filter-buttons">
      <button class="filter-btn" id="select-all">Select All / å…¨é€‰</button>
      <button class="filter-btn" id="unselect-all">Unselect All / å…¨ä¸é€‰</button>
    </div>
    
    <div id="category-list">
      <!-- åˆ†ç±»é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>
  <div class="osm-attribution">
    Â© <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors | Data available under ODbL<br>
  </div>
  <div class="feedback-note">
    Feedback / åé¦ˆ: via
    <a href="https://github.com/HaoTian22/BNBU-Map/issues" target="_blank">GitHub Issues</a>
    or
    <a href="mailto:hao_tian22@outlook.com">Email</a>
</div>

<script>
  // åŠ è½½è¿›åº¦ç®¡ç†
  let pbfLoadDetected = false;
  let styleLoaded = false;
  let tilesLoaded = false;
  const loadingOverlay = document.getElementById('loading-overlay');
  const loadingProgress = document.getElementById('loading-progress');
  
  // æ›´æ–°åŠ è½½è¿›åº¦
  function updateLoadingProgress(progress) {
    if (loadingProgress) {
      loadingProgress.style.width = progress + '%';
    }
  }
  
  // éšè—åŠ è½½æ¡
  function hideLoadingOverlay() {
    if (loadingOverlay && !loadingOverlay.classList.contains('fade-out')) {
      updateLoadingProgress(100);
      setTimeout(() => {
        loadingOverlay.classList.add('fade-out');
        setTimeout(() => {
          loadingOverlay.style.display = 'none';
        }, 500);
      }, 300);
    }
  }
  
  // ç›‘å¬ç½‘ç»œè¯·æ±‚ä»¥æ£€æµ‹pbfæ–‡ä»¶åŠ è½½
  const originalFetch = window.fetch;
  let pbfRequestCount = 0;
  let pbfLoadedCount = 0;
  
  window.fetch = function(...args) {
    const url = args[0];
    
    // æ£€æµ‹pbfæ–‡ä»¶è¯·æ±‚
    if (typeof url === 'string' && url.includes('.pbf')) {
      pbfRequestCount++;
      pbfLoadDetected = true;
      
      return originalFetch.apply(this, args).then(response => {
        if (response.ok) {
          pbfLoadedCount++;
          // æ›´æ–°è¿›åº¦ï¼ˆpbfåŠ è½½å 60%ï¼‰
          const pbfProgress = Math.min((pbfLoadedCount / Math.max(pbfRequestCount, 1)) * 60, 60);
          updateLoadingProgress(pbfProgress);
          
          // å¦‚æœç¬¬ä¸€ä¸ªpbfæ–‡ä»¶åŠ è½½å®Œæˆ
          if (pbfLoadedCount === 1) {
            console.log('First pbf tile loaded');
          }
        }
        return response;
      }).catch(error => {
        console.error('Error loading pbf:', error);
        return Promise.reject(error);
      });
    }
    
    return originalFetch.apply(this, args);
  };
  
  // åˆå§‹è¿›åº¦
  updateLoadingProgress(10);
  
  // ä» URL æˆ– LocalStorage è¯»å–ä½ç½®å‚æ•°
  function getInitialMapState() {
    // é»˜è®¤ä½ç½®
    const defaults = {
      center: [113.514982, 22.354065],
      zoom: 17,
      poiId: null
    };
    
    // ä¼˜å…ˆä» URL è¯»å–å‚æ•° (æ ¼å¼: #map=zoom/lat/lng æˆ– #map=zoom/lat/lng&poi=id)
    const hash = window.location.hash;
    if (hash) {
      const match = hash.match(/#map=([\d.]+)\/([\d.]+)\/([\d.]+)/);
      if (match) {
        const zoom = parseFloat(match[1]);
        const lat = parseFloat(match[2]);
        const lng = parseFloat(match[3]);
        
        // è¯»å– POI ID
        const poiMatch = hash.match(/[&?]poi=([^&]+)/);
        const poiId = poiMatch ? poiMatch[1] : null;
        
        if (!isNaN(zoom) && !isNaN(lat) && !isNaN(lng)) {
          return { center: [lng, lat], zoom, poiId };
        }
      }
    }
    
    // å¦‚æœ URL æ²¡æœ‰å‚æ•°ï¼Œä» LocalStorage è¯»å–
    try {
      const saved = localStorage.getItem('mapState');
      if (saved) {
        const state = JSON.parse(saved);
        if (state.center && state.zoom) {
          return { 
            center: state.center, 
            zoom: state.zoom,
            poiId: null 
          };
        }
      }
    } catch (e) {
      console.warn('Failed to load map state from localStorage:', e);
    }
    
    return defaults;
  }
  
  const initialState = getInitialMapState();
  
  const map = new maplibregl.Map({
    container: 'map',
    style: 'https://maptiles.haotian22.top/styles/osm-liberty/style.json',
    center: initialState.center,
    zoom: initialState.zoom
  });
  
  // ç›‘å¬åœ°å›¾æ ·å¼åŠ è½½å®Œæˆ
  map.on('styledata', function() {
    if (!styleLoaded) {
      styleLoaded = true;
      updateLoadingProgress(30);
      console.log('Map style loaded');
    }
  });
  
  // ç›‘å¬åœ°å›¾æ•°æ®åŠ è½½ï¼ˆåŒ…æ‹¬ç“¦ç‰‡ï¼‰
  map.on('data', function(e) {
    if (e.isSourceLoaded && pbfLoadDetected && !tilesLoaded) {
      tilesLoaded = true;
      updateLoadingProgress(80);
    }
  });
  
  // ç›‘å¬åœ°å›¾å®Œå…¨åŠ è½½å®Œæˆ
  map.on('load', function() {
    console.log('Map fully loaded');
    updateLoadingProgress(90);
    hideLoadingOverlay();
  });
  
  // æ›´æ–° URL å’Œ LocalStorage
  function updateMapStateInURL() {
    const center = map.getCenter();
    const zoom = map.getZoom();
    
    // ä¿ç•™å½“å‰çš„ POI å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰
    const currentHash = window.location.hash;
    const poiMatch = currentHash.match(/[&?]poi=([^&]+)/);
    const poiParam = poiMatch ? '&poi=' + poiMatch[1] : '';
    
    // æ›´æ–° URL (æ ¼å¼: #map=zoom/lat/lng)
    const newHash = `#map=${zoom.toFixed(2)}/${center.lat.toFixed(6)}/${center.lng.toFixed(6)}${poiParam}`;
    window.history.replaceState(null, '', newHash);
    
    // ä¿å­˜åˆ° LocalStorage
    try {
      localStorage.setItem('mapState', JSON.stringify({
        center: [center.lng, center.lat],
        zoom: zoom
      }));
    } catch (e) {
      console.warn('Failed to save map state to localStorage:', e);
    }
  }
  
  // ç›‘å¬åœ°å›¾ç§»åŠ¨ç»“æŸäº‹ä»¶
  map.on('moveend', updateMapStateInURL);
  
  // åˆå§‹åŒ–æ—¶ä¹Ÿæ›´æ–°ä¸€æ¬¡ URL
  map.once('load', updateMapStateInURL);
  
  // ç›‘å¬URL hashå˜åŒ–ï¼ˆç”¨æˆ·åœ¨åœ°å€æ ç²˜è´´æ–°é“¾æ¥æ—¶ï¼‰
  window.addEventListener('hashchange', function() {
    const newState = getInitialMapState();
    
    // é£åˆ°æ–°ä½ç½®
    map.flyTo({
      center: newState.center,
      zoom: newState.zoom,
      duration: 1500
    });
    
    // å¦‚æœæœ‰POIå‚æ•°ï¼Œè·³è½¬åˆ°å¯¹åº”çš„POIï¼ˆåœ¨ä¸Šæ–¹å‡½æ•°åˆ›å»ºé‡Œæ›´æ”¹ï¼‰
    if (newState.poiId && markerData.length > 0) {
      const targetPOI = markerData.find(item => String(item.poiId) === String(newState.poiId));
      if (targetPOI) {
        setTimeout(() => {
          map.flyTo({
            center: targetPOI.lngLat,
            zoom: 18.5,
            duration: 2000
          });
          
          setTimeout(() => {
            targetPOI.marker.togglePopup();
          }, 1000);
        }, 500);
      }
    }
  });
  
  // ç›‘å¬é¦–æ¬¡æ¸²æŸ“å®Œæˆï¼ˆä½œä¸ºå¤‡ç”¨æ£€æµ‹ï¼‰
  map.on('idle', function() {
    if (!tilesLoaded) {
      tilesLoaded = true;
      hideLoadingOverlay();
    }
  });
  
  // è¶…æ—¶ä¿æŠ¤ï¼š15ç§’åè‡ªåŠ¨éšè—åŠ è½½æ¡
  setTimeout(() => {
    if (loadingOverlay && !loadingOverlay.classList.contains('fade-out')) {
      console.warn('Loading timeout, hiding overlay');
      hideLoadingOverlay();
    }
  }, 15000);
  
  // å®šä½åŠŸèƒ½
  let userLocationMarker = null;
  let watchId = null;
  let isTracking = false;
  let isFirstLocation = true; // æ ‡è®°æ˜¯å¦æ˜¯é¦–æ¬¡å®šä½
  let lastPosition = null; // ä¿å­˜ä¸Šæ¬¡ä½ç½®ç”¨äºå¯¹æ¯”
  
  const locateButton = document.getElementById('locate-button');
  
  // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼ˆç±³ï¼‰
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;
    
    const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    
    return R * c;
  }
  
  function updateUserLocation(position) {
    const { longitude, latitude, accuracy } = position.coords;
    
    // ç²¾åº¦è¿‡æ»¤ï¼šå¦‚æœç²¾åº¦å¤§äº50ç±³ï¼Œåˆ™å¿½ç•¥æ­¤æ¬¡æ›´æ–°ï¼ˆé¦–æ¬¡é™¤å¤–ï¼‰
    if (!isFirstLocation && accuracy > 50) {
      console.log(`å¿½ç•¥ä½ç²¾åº¦ä½ç½®: ${accuracy}m`);
      return;
    }
    
    // è·ç¦»è¿‡æ»¤ï¼šå¦‚æœä¸ä¸Šæ¬¡ä½ç½®è·ç¦»å°äº5ç±³ï¼Œåˆ™å¿½ç•¥æ­¤æ¬¡æ›´æ–°ï¼ˆé¦–æ¬¡é™¤å¤–ï¼‰
    if (lastPosition && !isFirstLocation) {
      const distance = calculateDistance(
        lastPosition.latitude,
        lastPosition.longitude,
        latitude,
        longitude
      );
      
      if (distance < 3) {
        return;
      }
    }
    
    // æ›´æ–°ä¸Šæ¬¡ä½ç½®
    lastPosition = { latitude, longitude };
    
    // å¦‚æœå·²å­˜åœ¨ç”¨æˆ·ä½ç½®æ ‡è®°ï¼Œåˆ™æ›´æ–°ä½ç½®
    if (userLocationMarker) {
      userLocationMarker.setLngLat([longitude, latitude]);
    } else {
      // åˆ›å»ºç”¨æˆ·ä½ç½®æ ‡è®°ï¼ˆè“è‰²åœ†ç‚¹ï¼‰
      const el = document.createElement('div');
      el.id = 'user-location-marker';
      el.innerHTML = `
        <svg width="40" height="40" viewBox="0 0 40 40" style="display: block;">
          <!-- å¤–åœˆå…‰æ™• -->
          <circle cx="20" cy="20" r="18" fill="rgba(37, 99, 235, 0.15)" />
          <!-- å†…åœˆ -->
          <circle cx="20" cy="20" r="12" fill="#2563EB" stroke="white" stroke-width="3" />
        </svg>
      `;
      el.style.width = '40px';
      el.style.height = '40px';
      el.style.cursor = 'pointer';
      
      userLocationMarker = new maplibregl.Marker({ 
        element: el,
        anchor: 'center'
      })
        .setLngLat([longitude, latitude])
        .addTo(map);
    }
    
    // åªåœ¨é¦–æ¬¡å®šä½æ—¶ç§»åŠ¨åœ°å›¾åˆ°ç”¨æˆ·ä½ç½®
    if (isFirstLocation) {
      isFirstLocation = false; // ç«‹å³è®¾ç½®ä¸ºfalseé˜²æ­¢é‡å¤è°ƒç”¨
      
      // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
      const isMobile = window.innerWidth <= 768;
      
      // ç§»åŠ¨ç«¯éœ€è¦è€ƒè™‘åº•éƒ¨æ§åˆ¶é¢æ¿çš„é«˜åº¦ï¼Œè°ƒæ•´paddingä½¿å®šä½ç‚¹åœ¨è§†è§‰ä¸­å¿ƒ
      const flyOptions = {
        center: [longitude, latitude],
        zoom: 17,
        duration: 2000
      };
      
      if (isMobile) {
        // ç§»åŠ¨ç«¯ï¼šåº•éƒ¨æœ‰æ§åˆ¶é¢æ¿ï¼Œæ·»åŠ åº•éƒ¨padding
        flyOptions.padding = { bottom: 150, top: 50, left: 0, right: 0 };
      }
      
      map.flyTo(flyOptions);
    }
    
    locateButton.classList.remove('locating');
    locateButton.classList.add('active');
    
    // GA4: å®šä½æˆåŠŸï¼ˆåªåœ¨é¦–æ¬¡å‘é€ï¼‰
    if (isFirstLocation && typeof gtag !== 'undefined') {
      gtag('event', 'location_success', {
        is_high_accuracy: accuracy <= 50
      });
    }
  }
  
  function handleLocationError(error) {
    console.error('å®šä½é”™è¯¯:', error);
    locateButton.classList.remove('locating', 'active');
    
    let errorMessage = 'Unable to get location / æ— æ³•è·å–ä½ç½®';
    let errorType = 'unknown';
    switch(error.code) {
      case error.PERMISSION_DENIED:
        errorMessage = 'Location permission denied / ä½ç½®æƒé™è¢«æ‹’ç»';
        errorType = 'permission_denied';
        break;
      case error.POSITION_UNAVAILABLE:
        errorMessage = 'Location unavailable / ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
        errorType = 'position_unavailable';
        break;
      case error.TIMEOUT:
        errorMessage = 'Location request timeout / å®šä½è¯·æ±‚è¶…æ—¶';
        errorType = 'timeout';
        break;
    }
    
    // GA4: å®šä½å¤±è´¥
    if (typeof gtag !== 'undefined') {
      gtag('event', 'location_error', {
        error_type: errorType,
        error_message: errorMessage
      });
    }
    
    alert(errorMessage);
    
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    isTracking = false;
  }
  
  locateButton.addEventListener('click', function() {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported / æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå®šä½åŠŸèƒ½');
      return;
    }
    
    if (isTracking) {
      // åœæ­¢è¿½è¸ª
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      isTracking = false;
      isFirstLocation = true; // é‡ç½®é¦–æ¬¡å®šä½æ ‡è®°
      lastPosition = null; // é‡ç½®ä¸Šæ¬¡ä½ç½®
      locateButton.classList.remove('active', 'locating');
      
      // GA4: å®šä½åœæ­¢
      if (typeof gtag !== 'undefined') {
        gtag('event', 'location_tracking', {
          action: 'stop'
        });
      }
      
      // ç§»é™¤ç”¨æˆ·ä½ç½®æ ‡è®°
      if (userLocationMarker) {
        userLocationMarker.remove();
        userLocationMarker = null;
      }
    } else {
      // å¼€å§‹è¿½è¸ª
      isTracking = true;
      isFirstLocation = true; // é‡ç½®é¦–æ¬¡å®šä½æ ‡è®°
      locateButton.classList.add('locating');
      
      // GA4: å®šä½å¼€å§‹
      if (typeof gtag !== 'undefined') {
        gtag('event', 'location_tracking', {
          action: 'start'
        });
      }
      
      // å…ˆç«‹å³è·å–ä¸€æ¬¡ä½ç½®å¹¶é£åˆ°è¯¥ä½ç½®
      navigator.geolocation.getCurrentPosition(
        updateUserLocation,
        handleLocationError,
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
      
      // ç„¶åæŒç»­è¿½è¸ªç”¨æˆ·ä½ç½®
      watchId = navigator.geolocation.watchPosition(
        updateUserLocation,
        handleLocationError,
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 5000 // å…è®¸ä½¿ç”¨5ç§’å†…çš„ç¼“å­˜ä½ç½®
        }
      );
    }
  });

  // åˆ†ç±»é¢œè‰²é…ç½®
  const categoryColors = {
    // å»ºç­‘ç‰©
    dormitory: { color: '#60A5FA', label: 'Dormitory / å®¿èˆæ¥¼' },
    university: { color: '#2563EB', label: 'Academic Building / æ•™å­¦æ¥¼' },
    building_other: { color: '#94A3B8', label: 'Other Building / å…¶ä»–å»ºç­‘' },
    
    // é¤é¥®
    restaurant: { color: '#EF4444', label: 'Restaurant / é¤å…' },
    cafe: { color: '#F87171', label: 'Cafe / å’–å•¡å…' },
    food_court: { color: '#DC2626', label: 'Food Court / é£Ÿå ‚' },
    fast_food: { color: '#FCA5A5', label: 'Fast Food / å¿«é¤' },
    
    // å•†åº—
    shop: { color: '#F59E0B', label: 'Shop / å•†åº—' },
    
    // åŠå…¬å®¤
    office: { color: '#8B5CF6', label: 'Office / åŠå…¬å®¤' },
    
    // è®¾æ–½æœåŠ¡
    amenity: { color: '#10B981', label: 'Amenity / è®¾æ–½' },
    parking: { color: '#059669', label: 'Parking / åœè½¦' },
    
    // åŒ»ç–—
    healthcare: { color: '#EC4899', label: 'Healthcare / åŒ»ç–—' },
    
    // æ—…æ¸¸æ–‡åŒ–
    tourism: { color: '#14B8A6', label: 'Tourism / æ—…æ¸¸' },
    
    // ä¼‘é—²å¨±ä¹
    leisure: { color: '#F97316', label: 'Leisure / ä¼‘é—²' },
    
    // é»˜è®¤
    default: { color: '#6B7280', label: 'POI / åœ°ç‚¹' }
  };
  
  // å®šä¹‰åˆ†ç»„æ˜ å°„å…³ç³»ï¼ˆé›†ä¸­é…ç½®ï¼‰
  const categoryGroups = {
    buildings: {
      categories: ['dormitory', 'university', 'building_other'],
      label: 'Buildings / å»ºç­‘'
    },
    dining: {
      categories: ['restaurant', 'cafe', 'food_court', 'fast_food'],
      label: 'Dining / é¤é¥®'
    },
    shop: {
      categories: ['shop'],
      label: 'Shop / å•†åº—'
    },
    office: {
      categories: ['office'],
      label: 'Office / åŠå…¬å®¤'
    },
    facilities: {
      categories: ['amenity', 'parking'],
      label: 'Facilities / è®¾æ–½'
    },
    healthcare: {
      categories: ['healthcare'],
      label: 'Healthcare / åŒ»ç–—'
    },
    tourism: {
      categories: ['tourism'],
      label: 'Tourism / æ—…æ¸¸'
    },
    leisure: {
      categories: ['leisure'],
      label: 'Leisure / ä¼‘é—²'
    },
    default: {
      categories: ['default'],
      label: 'Other / å…¶ä»–'
    }
  };
  
  // åŠ¨æ€ç”Ÿæˆåˆ†ç±»é€‰é¡¹
  function generateCategoryItems() {
    const categoryList = document.getElementById('category-list');
    
    Object.keys(categoryGroups).forEach(groupKey => {
      const group = categoryGroups[groupKey];
      const categoryItem = document.createElement('div');
      categoryItem.className = 'category-item selected';
      categoryItem.dataset.group = groupKey;
      
      // åˆ›å»ºé¢œè‰²æŒ‡ç¤ºå™¨å®¹å™¨
      const colorIndicators = document.createElement('div');
      colorIndicators.className = 'color-indicators';
      
      // æ·»åŠ æ¯ä¸ªåˆ†ç±»çš„é¢œè‰²æŒ‡ç¤ºå™¨
      group.categories.forEach(catKey => {
        if (categoryColors[catKey]) {
          const indicator = document.createElement('span');
          indicator.className = 'color-indicator';
          indicator.style.background = categoryColors[catKey].color;
          colorIndicators.appendChild(indicator);
        }
      });
      
      // åˆ›å»ºæ ‡ç­¾
      const label = document.createElement('span');
      label.textContent = group.label;
      
      categoryItem.appendChild(colorIndicators);
      categoryItem.appendChild(label);
      categoryList.appendChild(categoryItem);
    });
  }
  
  // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆåˆ†ç±»é¡¹
  generateCategoryItems();

  // å­˜å‚¨æ‰€æœ‰æ ‡è®°ç‚¹
  const markers = [];
  const markerData = []; // å­˜å‚¨æ ‡è®°ç‚¹çš„è¯¦ç»†æ•°æ®ç”¨äºæœç´¢
  
  // ä½¿ç”¨ pinyin-pro åº“è¿›è¡Œæ‹¼éŸ³è½¬æ¢
  function getPinyin(text) {
    if (!text) return '';
    try {
      // ä½¿ç”¨ pinyin-pro çš„ pinyin å‡½æ•°ï¼Œå»é™¤å£°è°ƒï¼Œè¿”å›è¿ç»­çš„æ‹¼éŸ³
      return window.pinyinPro.pinyin(text, { toneType: 'none', type: 'array' }).join('').toLowerCase();
    } catch (e) {
      console.warn('æ‹¼éŸ³è½¬æ¢å¤±è´¥:', e);
      return text.toLowerCase();
    }
  }

  // æ ¹æ®å±æ€§ç¡®å®šç±»åˆ«å’Œé¢œè‰²
  function getCategoryInfo(props) {
    // å»ºç­‘ç‰©åˆ†ç±»
    if (props.building === 'dormitory') {
      return categoryColors.dormitory;
    }
    if (props.building === 'university') {
      return categoryColors.university;
    }
    if (props.building && props.building !== 'yes') {
      return categoryColors.building_other;
    }
    
    // é¤é¥®åˆ†ç±»
    if (props.amenity === 'restaurant') return categoryColors.restaurant;
    if (props.amenity === 'cafe') return categoryColors.cafe;
    if (props.amenity === 'food_court') return categoryColors.food_court;
    if (props.amenity === 'fast_food') return categoryColors.fast_food;
    
    // å•†åº—
    if (props.shop) return categoryColors.shop;
    
    // åŠå…¬å®¤
    if (props.office) return categoryColors.office;
    
    // åœè½¦
    if (props.amenity && (props.amenity.includes('parking') || props.amenity === 'bicycle_parking')) {
      return categoryColors.parking;
    }
    
    // åŒ»ç–—
    if (props.healthcare || props.amenity === 'doctors' || props.emergency === 'defibrillator') return categoryColors.healthcare;
    
    // æ—…æ¸¸
    if (props.tourism) return categoryColors.tourism;
    
    // ä¼‘é—²
    if (props.leisure) return categoryColors.leisure;
    
    // å…¶ä»–è®¾æ–½
    if (props.amenity) return categoryColors.amenity;
    
    // é»˜è®¤
    return categoryColors.default;
  }

  // ä»æœ¬åœ° POI.json æ–‡ä»¶è¯»å–æ•°æ®
  fetch("POI.json")
    .then(res => res.json())
    .then(data => {
      data.elements.forEach(element => {
        let lon, lat;

        // å¤„ç†ä¸åŒçš„å…ƒç´ ç±»å‹
        if (element.type === 'node') {
          lat = element.lat;
          lon = element.lon;
        } else if (element.type === 'way' || element.type === 'relation') {
          // ä½¿ç”¨ä¸­å¿ƒç‚¹
          if (element.center) {
            lat = element.center.lat;
            lon = element.center.lon;
          } else {
            return; // è·³è¿‡æ²¡æœ‰ä¸­å¿ƒç‚¹çš„å…ƒç´ 
          }
        } else {
          return; // è·³è¿‡å…¶ä»–ç±»å‹
        }

        const props = element.tags || {};
        
        // è·å–POIçš„çœŸå®ID
        const poiId = element.id;
        
        // ç‰¹æ®Šåç§°å¤„ç†
        if (props.emergency === 'defibrillator' && !props.name) {
          props['name:en'] = 'AED';
          props['name:zh'] = 'è‡ªåŠ¨ä½“å¤–é™¤é¢¤å™¨';
          props.name = 'AED';
        }
        if ((props.amenity === 'lost_property_office' || props.office === 'lost_property') && !props.name) {
          props['name:en'] = 'Lost and Found';
          props['name:zh'] = 'å¤±ç‰©æ‹›é¢†å¤„';
          props.name = 'Lost and Found';
        }
        if (props.amenity === 'fire_station' && !props.name) {
          props['name:en'] = 'Fire Station';
          props['name:zh'] = 'æ¶ˆé˜²ç«™';
          props.name = 'Fire Station';
        }
        // parking_entrance
        if (props.amenity === 'parking_entrance' && !props.name) {
          props['name:en'] = 'Parking Entrance';
          props['name:zh'] = 'åœè½¦åœºå…¥å£';
          props.name = 'Parking Entrance';
        }
        // waste_disposal
        if (props.amenity === 'waste_disposal' && !props.name) {
          props['name:en'] = 'Waste Disposal';
          props['name:zh'] = 'åƒåœ¾å›æ”¶ç‚¹';
          props.name = 'Waste Disposal';
        }
        // parking
        if (props.amenity === 'parking' && !props.name) {
          props['name:en'] = 'Parking';
          props['name:zh'] = 'åœè½¦åœº';
          props.name = 'Parking';
        }
        // bicycle_parking
        if (props.amenity === 'bicycle_parking' && !props.name) {
          props['name:en'] = 'Bicycle Parking';
          props['name:zh'] = 'è‡ªè¡Œè½¦åœè½¦ç‚¹';
          props.name = 'Bicycle Parking';
        }
        // waste_transfer_station
        if (props.amenity === 'waste_transfer_station' && !props.name) {
          props['name:en'] = 'Waste Transfer Station';
          props['name:zh'] = 'åƒåœ¾ä¸­è½¬ç«™';
          props.name = 'Waste Transfer Station';
        }
        // fire_hydrant
        if (props.emergency === 'fire_hydrant' && !props.name) {
          props['name:en'] = 'Fire Hydrant';
          props['name:zh'] = 'æ¶ˆé˜²æ “';
          props.name = 'Fire Hydrant';
        }
        
        // å¤„ç†åç§°ï¼šè‹±æ–‡/ä¸­æ–‡æ ¼å¼
        let displayName = "æœªå‘½å";
        const nameEn = props?.['name:en'];
        const nameZh = props?.['name:zh'] || props?.name;
        
        if (nameEn && nameZh) {
          displayName = `${nameEn} <br> ${nameZh}`;
        } else if (nameEn) {
          displayName = nameEn;
        } else if (nameZh) {
          displayName = nameZh;
        }
        
        const categoryInfo = getCategoryInfo(props);

        // æ„å»ºå¼¹çª—å†…å®¹
        let popupContent = `<div style="font-family: Arial, sans-serif;">
          <h3 style="margin: 0 0 8px 0; color: ${categoryInfo.color};">${displayName}</h3>
          <p style="margin: 4px 0; color: #666;"> ${categoryInfo.label}</p>`;
        
        // æ·»åŠ ä½ç½®ä¿¡æ¯ï¼ˆaddr:unit å’Œ addr:doorï¼‰
        const addrUnit = props['addr:unit'];
        const addrDoor = props['addr:door'];
        if (addrUnit && addrDoor) {
          popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Location / ä½ç½®:</strong> ${addrUnit}-${addrDoor}</p>`;
        } else if (addrUnit) {
          popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Location / ä½ç½®:</strong> ${addrUnit}</p>`;
        } else if (addrDoor) {
          popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Location / ä½ç½®:</strong> ${addrDoor}</p>`;
        }
        
        // æ·»åŠ å…¶ä»–æœ‰ç”¨ä¿¡æ¯
        if (props.amenity) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Amenity / è®¾æ–½:</strong> ${props.amenity}</p>`;
        if (props.building && props.building !== 'yes') popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Building / å»ºç­‘:</strong> ${props.building}</p>`;
        if (props.shop) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Shop / å•†åº—:</strong> ${props.shop}</p>`;
        if (props.cuisine) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Cuisine / èœç³»:</strong> ${props.cuisine}</p>`;
        if (props.opening_hours) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Opening Hours / è¥ä¸šæ—¶é—´:</strong> ${props.opening_hours}</p>`;
        
        // æ·»åŠ æ›´å¤šä¸“æœ‰å±æ€§
        if (props['level:ref']) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Floor / æ¥¼å±‚:</strong> ${props['level:ref']}</p>`;
        if (props.emergency) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Emergency / åº”æ€¥è®¾æ–½:</strong> ${props.emergency}</p>`;
        if (props['defibrillator:location']) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Location / ä½ç½®:</strong> ${props['defibrillator:location']}</p>`;
        if (props.phone) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Phone / ç”µè¯:</strong> ${props.phone}</p>`;
        if (props.website) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Website / ç½‘ç«™:</strong> <a href="${props.website}" target="_blank" style="color: ${categoryInfo.color};">é“¾æ¥</a></p>`;
        if (props.email) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Email / é‚®ç®±:</strong> <a href="mailto:${props.email}" style="color: ${categoryInfo.color};">${props.email}</a></p>`;
        if (props.note) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Note / å¤‡æ³¨:</strong> ${props.note}</p>`;
        if (props.description) popupContent += `<p style="margin: 4px 0; color: #666;"><strong>Description / æè¿°:</strong> ${props.description}</p>`;
        
        // æ·»åŠ åˆ†äº«æŒ‰é’®
        popupContent += `
          <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #eee;">
            <button onclick="
              const url = window.location.origin + window.location.pathname + '#map=' + ${map.getZoom().toFixed(2)} + '/' + ${lat.toFixed(6)} + '/' + ${lon.toFixed(6)} + '&poi=${poiId}';
              if (typeof gtag !== 'undefined') {
                gtag('event', 'share', {
                  method: 'copy_link',
                  content_type: 'poi',
                  item_id: '${poiId}',
                  item_name: '${displayName.replace('<br>', ' ').replace(/'/g, "\\'")}'  
                });
              }
              navigator.clipboard.writeText(url).then(() => {
                alert('Link copied! / é“¾æ¥å·²å¤åˆ¶ï¼');
              }).catch(() => {
                prompt('Copy this link / å¤åˆ¶æ­¤é“¾æ¥:', url);
              });
            " style="width: 100%; padding: 8px 12px; background: ${categoryInfo.color}; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-family: Arial, sans-serif; transition: opacity 0.2s;" 
            onmouseover="this.style.opacity='0.8'" 
            onmouseout="this.style.opacity='1'">
              ğŸ“‹ Copy Share Link / å¤åˆ¶åˆ†äº«é“¾æ¥
            </button>
          </div>
        `;
        
        popupContent += '</div>';

        const popup = new maplibregl.Popup().setHTML(popupContent);
        
        // ç›‘å¬popupå…³é—­äº‹ä»¶ï¼Œå»¶è¿Ÿç§»é™¤URLä¸­çš„poiå‚æ•°
        popup.on('close', () => {
          // å»¶è¿Ÿ50msæ£€æŸ¥ï¼Œå¦‚æœæ˜¯åˆ‡æ¢åˆ°å¦ä¸€ä¸ªPOIï¼ŒURLå·²ç»è¢«æ›´æ–°ï¼Œå°±ä¸è¦ç§»é™¤poiå‚æ•°
          setTimeout(() => {
            const currentHash = window.location.hash;
            // å¦‚æœå½“å‰URLä¸­è¿˜æœ‰poiå‚æ•°ï¼Œè¯´æ˜æ˜¯åˆ‡æ¢åˆ°äº†å¦ä¸€ä¸ªPOIï¼Œä¸è¦ç§»é™¤
            if (currentHash.includes('&poi=')) {
              return;
            }
            // å¦åˆ™ç§»é™¤poiå‚æ•°
            const center = map.getCenter();
            const zoom = map.getZoom();
            const newHash = `#map=${zoom.toFixed(2)}/${center.lat.toFixed(6)}/${center.lng.toFixed(6)}`;
            window.history.replaceState(null, '', newHash);
          }, 50);
        });
        
        // ä¿å­˜åŸå§‹çš„removeæ–¹æ³•
        const originalRemove = popup.remove.bind(popup);
        let isClosing = false;
        
        // é‡å†™removeæ–¹æ³•ä»¥æ·»åŠ å…³é—­åŠ¨ç”»
        popup.remove = function() {
          if (isClosing) return this;
          isClosing = true;
          
          const popupElement = this._container;
          if (popupElement) {
            popupElement.classList.add('closing');
            // ç­‰å¾…åŠ¨ç”»å®Œæˆåå†çœŸæ­£å…³é—­
            setTimeout(() => {
              originalRemove();
              isClosing = false;
            }, 200); // ä¸åŠ¨ç”»æ—¶é•¿ä¸€è‡´
          } else {
            originalRemove();
            isClosing = false;
          }
          return this;
        };

        const marker = new maplibregl.Marker({
          color: categoryInfo.color
        })
          .setLngLat([lon, lat])
          .setPopup(popup)
          .addTo(map);
        
        // æ ‡è®°ç‚¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ä»¥æ›´æ–°URL
        marker.getElement().addEventListener('click', () => {
          const center = map.getCenter();
          const zoom = map.getZoom();
          const newHash = `#map=${zoom.toFixed(2)}/${center.lat.toFixed(6)}/${center.lng.toFixed(6)}&poi=${poiId}`;
          window.history.replaceState(null, '', newHash);
          
          // GA4: POIç‚¹å‡»äº‹ä»¶
          if (typeof gtag !== 'undefined') {
            gtag('event', 'select_poi', {
              poi_id: poiId,
              poi_name: displayName.replace('<br>', ' '),
              poi_category: categoryInfo.label,
              method: 'marker_click'
            });
          }
        });
        
        // è·å–ç±»åˆ«é”®å
        const categoryKey = Object.keys(categoryColors).find(key => 
          categoryColors[key].color === categoryInfo.color && 
          categoryColors[key].label === categoryInfo.label
        );
        
        // å­˜å‚¨æ ‡è®°ç‚¹åŠå…¶ç±»åˆ«
        markers.push({
          marker: marker,
          category: categoryKey || 'default'
        });
        
        // å­˜å‚¨ç”¨äºæœç´¢çš„æ•°æ®
        markerData.push({
          marker: marker,
          category: categoryKey || 'default',
          name: displayName.replace('<br>', ' '),
          nameEn: nameEn || '',
          nameZh: nameZh || '',
          namePinyin: getPinyin(nameZh || ''),
          shortName: props.short_name || '',
          shortNamePinyin: getPinyin(props.short_name || ''),
          categoryLabel: categoryInfo.label,
          lngLat: [lon, lat],
          props: props,
          poiId: poiId
        });
      });
      
      // å¦‚æœ URL ä¸­æœ‰ POI å‚æ•°ï¼Œè‡ªåŠ¨æ‰“å¼€å¯¹åº”çš„æ ‡è®°
      if (initialState.poiId) {
        // è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒï¼ˆå› ä¸ºURLä¸­æ˜¯å­—ç¬¦ä¸²ï¼‰
        const targetPOI = markerData.find(item => String(item.poiId) === String(initialState.poiId));
        if (targetPOI) {
          setTimeout(() => {
            // é£åˆ°ç›®æ ‡ä½ç½®
            map.flyTo({
              center: targetPOI.lngLat,
              zoom: 18.5,
              duration: 2000
            });
            
            // æ‰“å¼€ popup
            setTimeout(() => {
              targetPOI.marker.togglePopup();
            }, 1500);
          }, 1000);
        }
      }
      
      // æœç´¢åŠŸèƒ½
      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');
      
      // é˜²æŠ–å®šæ—¶å™¨ï¼Œé¿å…é¢‘ç¹ä¸ŠæŠ¥æœç´¢äº‹ä»¶
      let searchDebounceTimer = null;
      
      searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query.length === 0) {
          searchResults.classList.remove('show');
          searchResults.innerHTML = '';
          // æ¸…é™¤é˜²æŠ–å®šæ—¶å™¨
          if (searchDebounceTimer) {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = null;
          }
          return;
        }
        
        // GA4: æœç´¢äº‹ä»¶ï¼ˆé˜²æŠ–ï¼šç”¨æˆ·åœæ­¢è¾“å…¥1.5ç§’åæ‰ä¸ŠæŠ¥ï¼‰
        if (typeof gtag !== 'undefined' && query.length >= 2) {
          // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
          if (searchDebounceTimer) {
            clearTimeout(searchDebounceTimer);
          }
          // è®¾ç½®æ–°çš„å®šæ—¶å™¨
          searchDebounceTimer = setTimeout(() => {
            gtag('event', 'search', {
              search_term: query
            });
          }, 1500); // 1.5ç§’åä¸ŠæŠ¥
        }
        
        // æœç´¢åŒ¹é…é¡¹
        let matches = markerData.filter(item => {
          return item.nameEn.toLowerCase().includes(query) ||
                 item.nameZh.toLowerCase().includes(query) ||
                 item.namePinyin.includes(query) ||
                 item.shortName.toLowerCase().includes(query) ||
                 item.shortNamePinyin.includes(query) ||
                 item.categoryLabel.toLowerCase().includes(query) ||
                 item.props.amenity?.toLowerCase().includes(query) ||
                 item.props.building?.toLowerCase().includes(query) ||
                 item.props.shop?.toLowerCase().includes(query) ||
                 item.props.emergency?.toLowerCase().includes(query) ||
                 item.props.office?.toLowerCase().includes(query) ||
                 item.props.tourism?.toLowerCase().includes(query) ||
                 item.props.leisure?.toLowerCase().includes(query) ||
                 item.props.healthcare?.toLowerCase().includes(query);
        });
        
        // å¦‚æœå®šä½å·²å¼€å¯ï¼Œå¯¹åŒååœ°ç‚¹æŒ‰è·ç¦»æ’åº
        if (lastPosition && isTracking && matches.length > 1) {
          matches.sort((a, b) => {
            // é¦–å…ˆæ¯”è¾ƒåç§°
            const nameCompare = a.name.localeCompare(b.name);
            
            // å¦‚æœåç§°ç›¸åŒï¼ŒæŒ‰è·ç¦»æ’åºï¼ˆè¿‘çš„åœ¨å‰ï¼‰
            if (nameCompare === 0) {
              const distA = calculateDistance(
                lastPosition.latitude,
                lastPosition.longitude,
                a.lngLat[1],
                a.lngLat[0]
              );
              const distB = calculateDistance(
                lastPosition.latitude,
                lastPosition.longitude,
                b.lngLat[1],
                b.lngLat[0]
              );
              return distA - distB;
            }
            
            // åç§°ä¸åŒæ—¶ä¿æŒåŸé¡ºåº
            return 0;
          });
        }
        
        matches = matches.slice(0, 10); // æœ€å¤šæ˜¾ç¤º10æ¡ç»“æœ
        
        if (matches.length > 0) {
          searchResults.innerHTML = matches.map(item => {
            let distanceHtml = '';
            // å¦‚æœå®šä½å·²å¼€å¯ä¸”æœ‰ç”¨æˆ·ä½ç½®ï¼Œè®¡ç®—å¹¶æ˜¾ç¤ºè·ç¦»
            if (lastPosition && isTracking) {
              const distance = calculateDistance(
                lastPosition.latitude,
                lastPosition.longitude,
                item.lngLat[1],
                item.lngLat[0]
              );
              
              // æ ¼å¼åŒ–è·ç¦»æ˜¾ç¤º
              let distanceText;
              if (distance < 1000) {
                distanceText = Math.round(distance) + 'm';
              } else {
                distanceText = (distance / 1000).toFixed(1) + 'km';
              }
              
              distanceHtml = `<div class="search-result-distance">${distanceText}</div>`;
            }
            
            return `
              <div class="search-result-item" data-index="${markerData.indexOf(item)}">
                <div class="search-result-info">
                  <div class="search-result-name">${item.name || 'æœªå‘½å'}</div>
                  <div class="search-result-category">${item.categoryLabel}</div>
                </div>
                ${distanceHtml}
              </div>
            `;
          }).join('');
          searchResults.classList.add('show');
        } else {
          searchResults.innerHTML = '<div class="search-result-item">No results / æ— ç»“æœ</div>';
          searchResults.classList.add('show');
        }
      });
      
      // ç‚¹å‡»æœç´¢ç»“æœ
      searchResults.addEventListener('click', function(e) {
        const item = e.target.closest('.search-result-item');
        if (item && item.dataset.index) {
          const data = markerData[parseInt(item.dataset.index)];
          
          // GA4: é€‰æ‹©æœç´¢ç»“æœ
          if (typeof gtag !== 'undefined') {
            gtag('event', 'select_content', {
              content_type: 'search_result',
              item_id: data.poiId,
              item_name: data.name,
              item_category: data.categoryLabel
            });
          }
          
          // å®šä½åˆ°æ ‡è®°ç‚¹
          map.flyTo({
            center: data.lngLat,
            zoom: 18.5,
            duration: 2000
          });
          
          // æ‰“å¼€å¼¹çª—
          setTimeout(() => {
            data.marker.togglePopup();
          }, 1000);
          
          // æ¸…ç©ºæœç´¢
          searchInput.value = '';
          searchResults.classList.remove('show');
          searchResults.innerHTML = '';
        }
      });
      
      // ç‚¹å‡»åœ°å›¾å…¶ä»–åœ°æ–¹å…³é—­æœç´¢ç»“æœ
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
          searchResults.classList.remove('show');
        }
      });
      
      // å›¾å±‚æ§åˆ¶é¢æ¿å±•å¼€/æ”¶èµ·
      const layerControl = document.querySelector('.layer-control');
      const layerToggle = document.getElementById('layer-toggle');
      const toggleText = document.getElementById('toggle-text');
      const layerControlContent = document.querySelector('.layer-control-content');
      
      // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
      function isMobile() {
        return window.innerWidth <= 768;
      }
      
      // åŠ¨æ€è®¾ç½®å†…å®¹çš„max-heightä¸ºå®é™…é«˜åº¦
      function updateContentHeight() {
        if (layerControlContent) {
          // ä¿å­˜å½“å‰çŠ¶æ€
          const wasCollapsed = layerControl.classList.contains('collapsed');
          
          // å®Œå…¨ç¦ç”¨è¿‡æ¸¡åŠ¨ç”»ï¼Œé¿å…è§¦å‘åŠ¨ç”»
          const originalTransition = layerControlContent.style.transition;
          layerControlContent.style.transition = 'none';
          
          // ä¸´æ—¶ç§»é™¤collapsedç±»ä»¥æµ‹é‡
          layerControl.classList.remove('collapsed');
          
          // ä¸´æ—¶ç§»é™¤max-heighté™åˆ¶
          const originalMaxHeight = layerControlContent.style.maxHeight;
          layerControlContent.style.maxHeight = 'none';
          
          // å¼ºåˆ¶é‡æ’ä»¥ç¡®ä¿æ ·å¼ç”Ÿæ•ˆ
          layerControlContent.offsetHeight;
          
          // æµ‹é‡å®é™…é«˜åº¦
          const actualHeight = layerControlContent.scrollHeight;
          
          // è®¡ç®—å¯ç”¨ç©ºé—´ï¼šè€ƒè™‘ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯çš„å·®å¼‚
          const mobile = isMobile();
          let maxAllowedHeight;
          
          if (mobile) {
            // ç§»åŠ¨ç«¯ï¼š.layer-control é™åˆ¶ä¸º 60vhï¼Œéœ€è¦å‡å»æŒ‰é’®ã€paddingç­‰çš„é«˜åº¦
            const controlButtons = layerControl.querySelector('.control-buttons');
            const buttonsHeight = controlButtons ? controlButtons.offsetHeight : 0;
            const padding = 10 * 2; // ç§»åŠ¨ç«¯ padding: 10px
            const margins = 10; // æŒ‰é’®å’Œå†…å®¹ä¹‹é—´çš„margin
            
            maxAllowedHeight = window.innerHeight * 0.65 - buttonsHeight - padding - margins;
          } else {
            // æ¡Œé¢ç«¯ï¼š.layer-control é™åˆ¶ä¸º 80vh
            const controlButtons = layerControl.querySelector('.control-buttons');
            const heading = layerControl.querySelector('h3');
            const attribution = layerControl.querySelector('.osm-attribution');
            const feedback = layerControl.querySelector('.feedback-note');
            
            const buttonsHeight = controlButtons ? controlButtons.offsetHeight : 0;
            const headingHeight = heading ? heading.offsetHeight : 0;
            const attributionHeight = attribution ? attribution.offsetHeight : 0;
            const feedbackHeight = feedback ? feedback.offsetHeight : 0;
            const padding = 15 * 2; // æ¡Œé¢ç«¯ padding: 15px
            const margins = 20; // å„å…ƒç´ ä¹‹é—´çš„é—´è·
            
            maxAllowedHeight = window.innerHeight * 0.8 - buttonsHeight - headingHeight - 
                             attributionHeight - feedbackHeight - padding - margins;
          }
          
          // è®¾ç½®max-heightä¸ºå®é™…é«˜åº¦å’Œå…è®¸çš„æœ€å¤§é«˜åº¦ä¸­çš„è¾ƒå°å€¼
          const finalHeight = Math.min(actualHeight, maxAllowedHeight);
          layerControlContent.style.maxHeight = finalHeight + 'px';
          
          // å¦‚æœä¹‹å‰æ˜¯æ”¶èµ·çŠ¶æ€ï¼Œç«‹å³æ¢å¤æ”¶èµ·ï¼ˆåœ¨æ¢å¤è¿‡æ¸¡ä¹‹å‰ï¼‰
          if (wasCollapsed) {
            layerControl.classList.add('collapsed');
          }
          
          // å¼ºåˆ¶é‡æ’
          layerControlContent.offsetHeight;
          
          // æ¢å¤è¿‡æ¸¡æ•ˆæœ
          layerControlContent.style.transition = originalTransition || '';
        }
      }
      
      // åˆå§‹åŒ–é¢æ¿çŠ¶æ€
      if (isMobile()) {
        layerControl.classList.add('collapsed');
      } else {
        layerControl.classList.remove('collapsed');
      }
      
      // åˆå§‹åŒ–æ—¶è®¾ç½®é«˜åº¦
      updateContentHeight();
      
      // çª—å£å¤§å°æ”¹å˜æ—¶æ›´æ–°é«˜åº¦ï¼ˆä¿æŒå½“å‰å±•å¼€/æ”¶èµ·çŠ¶æ€ï¼‰
      window.addEventListener('resize', updateContentHeight);
      
      if (layerToggle) {
        layerToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          layerControl.classList.toggle('collapsed');

          if (layerControl.classList.contains('collapsed')) {
            toggleText.textContent = 'âš™ Filters / ç­›é€‰';
            
            // GA4: é¢æ¿æ”¶èµ·
            if (typeof gtag !== 'undefined') {
              gtag('event', 'filter_panel', {
                action: 'collapse'
              });
            }
          } else {
            toggleText.textContent = 'âœ– Collapse / éšè—';
            
            // GA4: é¢æ¿å±•å¼€
            if (typeof gtag !== 'undefined') {
              gtag('event', 'filter_panel', {
                action: 'expand'
              });
            }
          }
        });
      }
      
      // å­˜å‚¨æ¯ä¸ªåˆ†ç»„çš„é€‰ä¸­çŠ¶æ€
      const groupStates = {};
      Object.keys(categoryGroups).forEach(group => {
        groupStates[group] = true; // åˆå§‹éƒ½æ˜¯é€‰ä¸­çŠ¶æ€
      });
      
      // æ›´æ–°æ ‡è®°ç‚¹å¯è§æ€§
      function updateMarkerVisibility() {
        markers.forEach(item => {
          const group = Object.keys(categoryGroups).find(g => 
            categoryGroups[g].categories.includes(item.category)
          );
          const isVisible = group && groupStates[group];
          const element = item.marker.getElement();
          
          if (isVisible) {
            element.classList.remove('marker-hidden');
          } else {
            element.classList.add('marker-hidden');
          }
        });
      }
      
      // ç‚¹å‡»åˆ†ç±»é¡¹åˆ‡æ¢é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.category-item').forEach(item => {
        item.addEventListener('click', function() {
          const group = this.dataset.group;
          groupStates[group] = !groupStates[group];
          this.classList.toggle('selected');
          updateMarkerVisibility();
          
          // GA4: ç±»åˆ«ç­›é€‰
          if (typeof gtag !== 'undefined') {
            gtag('event', 'filter_category', {
              category: group,
              category_label: categoryGroups[group].label,
              action: groupStates[group] ? 'enable' : 'disable'
            });
          }
        });
      });
      
      // Select All æŒ‰é’®
      document.getElementById('select-all').addEventListener('click', function() {
        Object.keys(groupStates).forEach(group => {
          groupStates[group] = true;
        });
        document.querySelectorAll('.category-item').forEach(item => {
          item.classList.add('selected');
        });
        updateMarkerVisibility();
        
        // GA4: å…¨é€‰
        if (typeof gtag !== 'undefined') {
          gtag('event', 'filter_action', {
            action: 'select_all'
          });
        }
      });
      
      // Unselect All æŒ‰é’®
      document.getElementById('unselect-all').addEventListener('click', function() {
        Object.keys(groupStates).forEach(group => {
          groupStates[group] = false;
        });
        document.querySelectorAll('.category-item').forEach(item => {
          item.classList.remove('selected');
        });
        updateMarkerVisibility();
        
        // GA4: å–æ¶ˆå…¨é€‰
        if (typeof gtag !== 'undefined') {
          gtag('event', 'filter_action', {
            action: 'unselect_all'
          });
        }
      });
    })
    .catch(err => {
      console.error('åŠ è½½ POI.json æ–‡ä»¶å¤±è´¥:', err);
      alert('æ— æ³•åŠ è½½ POI.json æ–‡ä»¶,è¯·ç¡®ä¿æ–‡ä»¶ä¸ HTML åœ¨åŒä¸€ç›®å½•ä¸‹');
    });
</script>
</body>
</html>
