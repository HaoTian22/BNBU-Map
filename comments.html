<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Comments / å…¨éƒ¨è¯„è®º | BNBU Map</title>
  <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: #f3f7fb;
      font-family: Arial, sans-serif;
      color: #333;
    }

    .header {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }

    .header-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #eff6ff;
      color: #2563EB;
      border: 1.5px solid #bfdbfe;
      border-radius: 30px;
      font-size: 13px;
      font-weight: 500;
      text-decoration: none;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .header-back:hover { background: #dbeafe; }

    .header-title {
      font-size: 17px;
      font-weight: bold;
      color: #1e3a5f;
    }
    .header-sub {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }

    .container {
      max-width: 860px;
      margin: 0 auto;
      padding: 32px 20px 60px;
    }

    /* æœ€è¿‘è¯„è®ºåˆ—è¡¨ */
    .section-title {
      font-size: 15px;
      font-weight: bold;
      color: #374151;
      margin: 0 0 16px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }

    .recent-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .comment-card {
      background: white;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      transition: box-shadow 0.2s;
    }
    .comment-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .comment-card-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .comment-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: #dbeafe;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #2563EB;
      font-weight: bold;
      flex-shrink: 0;
      overflow: hidden;
    }
    .comment-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .comment-author {
      font-weight: bold;
      font-size: 13px;
      color: #1f2937;
    }
    .comment-time {
      font-size: 11px;
      color: #9ca3af;
      margin-left: 6px;
      font-weight: normal;
    }
    .comment-poi {
      display: inline-block;
      margin-top: 4px;
      font-size: 11px;
      color: #2563EB;
      background: #eff6ff;
      padding: 3px 10px;
      border-radius: 30px;
      white-space: nowrap;
      text-decoration: none;
      max-width: 320px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .comment-poi:hover { background: #dbeafe; }

    .comment-body {
      font-size: 13px;
      line-height: 1.65;
      color: #374151;
    }
    .comment-body p { margin: 0 0 4px; }

    /* åŠ è½½çŠ¶æ€ */
    .loading-state {
      text-align: center;
      padding: 48px 0;
      color: #9ca3af;
      font-size: 14px;
    }
    .loading-spinner {
      width: 36px;
      height: 36px;
      border: 3px solid #e5e7eb;
      border-top: 3px solid #2563EB;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-state {
      text-align: center;
      padding: 48px 0;
      color: #ef4444;
      font-size: 14px;
    }

    .empty-state {
      text-align: center;
      padding: 48px 0;
      color: #9ca3af;
      font-size: 14px;
    }

    /* åˆ†é¡µ */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 28px;
    }
    .page-btn {
      padding: 8px 18px;
      border: 1.5px solid #e5e7eb;
      background: white;
      border-radius: 30px;
      font-size: 13px;
      cursor: pointer;
      color: #374151;
      transition: all 0.2s;
      font-family: Arial, sans-serif;
    }
    .page-btn:hover:not(:disabled) { background: #eff6ff; border-color: #bfdbfe; color: #2563EB; }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .page-btn.active { background: #2563EB; color: white; border-color: #2563EB; }

    .page-info {
      line-height: 36px;
      font-size: 13px;
      color: #6b7280;
    }

    @media (max-width: 600px) {
      .header { padding: 12px 16px; }
      .container { padding: 20px 12px 48px; }
      .comment-card { padding: 12px 14px; }
      .comment-poi { max-width: 280px; }
    }
  </style>
</head>
<body>

<div class="header">
  <a class="header-back" href="#" onclick="window.close(); return false;">â† è¿”å›åœ°å›¾</a>
  <div>
    <div class="header-title">å…¨éƒ¨è¯„è®º / All Comments</div>
    <div class="header-sub">æŒ‰æ—¶é—´é™åºæ’åˆ— Â· Sorted by newest first</div>
  </div>
</div>

<div class="container">
  <div class="section-title">æœ€æ–°è¯„è®º / Recent Comments</div>
  <div id="recent-list" class="recent-list">
    <div class="loading-state">
      <div class="loading-spinner"></div>
      åŠ è½½ä¸­ / Loading...
    </div>
  </div>
  <div class="pagination" id="pagination" style="display:none"></div>
</div>

<script>
  const WALINE_SERVER_URL = 'https://umap-comment.haotian22.top';
  const SERVER_URL = WALINE_SERVER_URL.replace(/\/$/, '');

  const PAGE_SIZE = 20;
  let currentPage = 1;
  let totalPages = 1;

  // POI id â†’ display name mapï¼Œä» POI.json æ„å»º
  const poiNameMap = {};

  function resolvePOIName(props) {
    // ç‰¹æ®Šåç§°å¤„ç†ï¼ˆä¸ index.html ä¿æŒä¸€è‡´ï¼‰
    if (props.emergency === 'defibrillator' && !props.name) {
      props['name:en'] = 'AED'; props['name:zh'] = 'è‡ªåŠ¨ä½“å¤–é™¤é¢¤å™¨'; props.name = 'AED';
    }
    if ((props.amenity === 'lost_property_office' || props.office === 'lost_property') && !props.name) {
      props['name:en'] = 'Lost and Found'; props['name:zh'] = 'å¤±ç‰©æ‹›é¢†å¤„'; props.name = 'Lost and Found';
    }
    if (props.amenity === 'fire_station' && !props.name) {
      props['name:en'] = 'Fire Station'; props['name:zh'] = 'æ¶ˆé˜²ç«™'; props.name = 'Fire Station';
    }
    if (props.amenity === 'parking_entrance' && !props.name) {
      props['name:en'] = 'Parking Entrance'; props['name:zh'] = 'åœè½¦åœºå…¥å£'; props.name = 'Parking Entrance';
    }
    if (props.amenity === 'waste_disposal' && !props.name) {
      props['name:en'] = 'Waste Disposal'; props['name:zh'] = 'åƒåœ¾å›æ”¶ç‚¹'; props.name = 'Waste Disposal';
    }
    if (props.amenity === 'parking' && !props.name) {
      props['name:en'] = 'Parking'; props['name:zh'] = 'åœè½¦åœº'; props.name = 'Parking';
    }
    if (props.amenity === 'bicycle_parking' && !props.name) {
      props['name:en'] = 'Bicycle Parking'; props['name:zh'] = 'è‡ªè¡Œè½¦åœè½¦ç‚¹'; props.name = 'Bicycle Parking';
    }
    if (props.amenity === 'waste_transfer_station' && !props.name) {
      props['name:en'] = 'Waste Transfer Station'; props['name:zh'] = 'åƒåœ¾ä¸­è½¬ç«™'; props.name = 'Waste Transfer Station';
    }
    if (props.emergency === 'fire_hydrant' && !props.name) {
      props['name:en'] = 'Fire Hydrant'; props['name:zh'] = 'æ¶ˆé˜²æ “'; props.name = 'Fire Hydrant';
    }
    const nameEn = props['name:en'];
    const nameZh = props['name:zh'] || props.name;
    if (nameEn && nameZh) return nameEn + ' / ' + nameZh;
    return nameEn || nameZh || 'æœªå‘½å';
  }

  // é¢„åŠ è½½ POI.json å»ºç«‹ id â†’ name æ˜ å°„
  fetch('POI.json')
    .then(r => r.json())
    .then(data => {
      data.elements.forEach(el => {
        const props = el.tags || {};
        poiNameMap[String(el.id)] = resolvePOIName(props);
      });
    })
    .catch(() => {}); // å¤±è´¥æ—¶é™é»˜ï¼Œå›é€€åˆ° POI #id æ˜¾ç¤º

  function formatTime(isoStr) {
    if (!isoStr) return '';
    const d = new Date(isoStr);
    const now = new Date();
    const diff = (now - d) / 1000;
    if (diff < 60) return 'åˆšåˆš';
    if (diff < 3600) return Math.floor(diff / 60) + ' åˆ†é’Ÿå‰';
    if (diff < 86400) return Math.floor(diff / 3600) + ' å°æ—¶å‰';
    if (diff < 432000) return Math.floor(diff / 86400) + ' å¤©å‰';
    return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
  }

  function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html || '';
    return tmp.textContent || tmp.innerText || '';
  }

  function avatarLetter(nick) {
    return (nick || '?')[0].toUpperCase();
  }

  function pathToLabel(path) {
    if (!path) return '';
    const m = path.match(/\/poi\/(.+)/);
    if (m) {
      const name = poiNameMap[m[1]];
      return 'ğŸ“ ' + (name || 'POI #' + m[1]);
    }
    return path;
  }

  function pathToMapUrl(path) {
    if (!path) return 'index.html';
    const m = path.match(/\/poi\/(.+)/);
    if (m) return 'index.html#poi=' + m[1];
    return 'index.html';
  }

  async function loadComments(page) {
    const listEl = document.getElementById('recent-list');
    const paginationEl = document.getElementById('pagination');

    listEl.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>åŠ è½½ä¸­ / Loading...</div>';
    paginationEl.style.display = 'none';

    if (!WALINE_SERVER_URL || WALINE_SERVER_URL === 'YOUR_WALINE_SERVER_URL') {
      listEl.innerHTML = '<div class="error-state">âš ï¸ è¯·å…ˆè®¾ç½® <code>WALINE_SERVER_URL</code><br><small>Please set WALINE_SERVER_URL in comments.html</small></div>';
      return;
    }

    try {
      const url = SERVER_URL + '/api/comment?type=recent&pageSize=' + PAGE_SIZE + '&page=' + page;
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();

      const comments = json.data || [];
      const total = json.totalComment || 0;
      totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      currentPage = page;

      if (comments.length === 0) {
        listEl.innerHTML = '<div class="empty-state">æš‚æ— è¯„è®º / No comments yet</div>';
        return;
      }

      listEl.innerHTML = comments.map(c => {
        const nick = c.nick || 'åŒ¿å';
        const timeStr = formatTime(c.time);
        const body = c.comment || '';
        const avatar = c.avatar;
        const path = c.url || '';
        const label = pathToLabel(path);
        const mapUrl = pathToMapUrl(path);
        const avatarHtml = avatar
          ? `<img src="${avatar}" alt="${nick}" onerror="this.style.display='none';this.parentElement.textContent='${avatarLetter(nick)}'">`
          : avatarLetter(nick);
        return `
          <div class="comment-card">
            <div class="comment-card-meta">
              <div class="comment-avatar">${avatarHtml}</div>
              <div>
                <div class="comment-author">${nick}<span class="comment-time">${timeStr}</span></div>
                ${label ? `<a class="comment-poi" href="${mapUrl}" title="${label}">${label}</a>` : ''}
              </div>
            </div>
            <div class="comment-body">${body}</div>
          </div>`;
      }).join('');

      // Pagination
      if (totalPages > 1) {
        let pagHtml = '';
        pagHtml += `<button class="page-btn" onclick="loadComments(${page - 1})" ${page <= 1 ? 'disabled' : ''}>â† ä¸Šä¸€é¡µ</button>`;
        pagHtml += `<span class="page-info">${page} / ${totalPages}</span>`;
        pagHtml += `<button class="page-btn" onclick="loadComments(${page + 1})" ${page >= totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ â†’</button>`;
        paginationEl.innerHTML = pagHtml;
        paginationEl.style.display = 'flex';
      }

    } catch(e) {
      console.error(e);
      listEl.innerHTML = '<div class="error-state">åŠ è½½å¤±è´¥ / Failed to load<br><small>' + e.message + '</small></div>';
    }
  }

  loadComments(1);
</script>
</body>
</html>
